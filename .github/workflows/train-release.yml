name: Train & Release Model

on:
  workflow_dispatch:
  push:
    branches:
      - 9-f9-automated-training

jobs:
  train-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Sync dependencies
        run: uv sync

      - name: Download dataset
        run: uv run python src/get_data.py

      - name: Preprocess data
        run: uv run python src/text_preprocessing.py

      - name: Train model
        run: uv run python src/text_classification.py
      
      - name: Read version
        id: version
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_ENV

      - name: Bump patch version
        id: bump
        run: |
          IFS='.' read -r major minor patch <<< "${VERSION}"
          patch=$((patch+1))
          new_version="$major.$minor.$patch"
          echo "$new_version" > VERSION
          echo "NEW_VERSION=$new_version" >> $GITHUB_ENV

      - name: Commit and push new version
        run: |
          git config user.email "github-actions@github.com"
          git config user.name "github-actions"
          git add VERSION
          git commit -m "Bump version to ${{ env.NEW_VERSION }}"
          git tag "v${{ env.NEW_VERSION }}"
          git push origin HEAD
          git push origin "v${{ env.NEW_VERSION }}"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.NEW_VERSION }}
          name: "v${{ env.NEW_VERSION }}"
          files: |
            output/model.joblib
            output/preprocessor.joblib
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
